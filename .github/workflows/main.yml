name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install project dependencies
        run: |
          if [ -f package-lock.json ] || [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found, skipping npm ci"
          fi

      - name: Install Wrangler (global)
        run: npm install -g wrangler@4.52.1

      - name: Set CF API token to environment
        if: ${{ secrets.CF_API_TOKEN != '' }}
        run: echo "CF_API_TOKEN=${{ secrets.CF_API_TOKEN }}" >> $GITHUB_ENV

      - name: Verify Wrangler installation
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          wrangler --version
          # 尝试验证身份；若失败会输出错误信息以便调试
          npx --yes wrangler whoami || true

      - name: Deploy to Cloudflare Workers
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          if [ -z "${CF_API_TOKEN}" ]; then
            echo "ERROR: CF_API_TOKEN is not set. Add it to repository secrets (Settings → Secrets and variables → Actions)."
            exit 1
          fi
          # 使用 wrangler deploy 发布（如需指定环境或项目配置，可在这里添加参数）
          wrangler deploy --env production
      - name: Create wrangler.toml
        env:
          USERNAME: ${{ secrets.USERNAME || '_user' }}
          PASSWORD: ${{ secrets.PASSWORD || '_pass' }}
          BUCKET_NAME: ${{ secrets.BUCKET_NAME || 'bucket' }}
        run: |
          sed -e "s/\$USERNAME/$USERNAME/g" \
              -e "s/\$PASSWORD/$PASSWORD/g" \
              -e "s/\$BUCKET_NAME/$BUCKET_NAME/g" \
              wrangler.toml.template > wrangler.toml
          cat wrangler.toml

      - name: Build & Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
